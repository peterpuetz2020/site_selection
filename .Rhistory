filter(!is.na(value)) %>%
ggplot(aes(x = Anfang_Probenahme, y = value)) +
geom_ribbon(
aes(ymin = loess_optimized_pw_lb_orig, ymax = loess_optimized_pw_ub_orig),
# shadowing cnf intervals
fill = "lightblue"
) +
geom_point(colour = "grey") +
geom_line(aes(Anfang_Probenahme,
y = loess_optimized_orig),
linewidth = 1) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_lb_orig),linewidth = 1, linetype = 0) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_ub_orig),linewidth = 1, linetype = 0) +
facet_wrap(~all_sites, ncol = 1,
labeller = labeller(all_sites = custom_labels)) +
theme_minimal() +
theme(
strip.text = element_text(size = 15),  # Increase facet title size
# Increase axis title size
axis.title.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
# Increase axis tick label size
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
) +
scale_x_date(date_breaks = "2 month",
date_labels = "%b %y") +
labs(y = expression(atop("Viral load in wastewater",atop(paste("in gene copies / liter (in thousand)")))),
x = "Date")
p_trans
p_trans <- df_agg %>%
filter(!is.na(value)) %>%
ggplot(aes(x = Anfang_Probenahme, y = value)) +
geom_ribbon(
aes(ymin = loess_optimized_pw_lb_orig, ymax = loess_optimized_pw_ub_orig),
# shadowing cnf intervals
fill = "lightblue"
) +
geom_point(colour = "grey") +
geom_line(aes(Anfang_Probenahme,
y = loess_optimized_orig),
linewidth = 1) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_lb_orig),linewidth = 1, linetype = 0) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_ub_orig),linewidth = 1, linetype = 0) +
facet_wrap(~all_sites, ncol = 1,
labeller = labeller(all_sites = custom_labels)) +
theme_minimal() +
theme(
strip.text = element_text(size = 15),  # Increase facet title size
# Increase axis title size
axis.title.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
# Increase axis tick label size
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
) +
scale_x_date(date_breaks = "2 month",
date_labels = "%b %y") +
labs(y = expression(atop("Viral load in wastewater",atop(paste("in gene copies / liter (in thousand)")))),
x = "Date")
p_trans
# combine datasets
df_agg <- map_dfr(agg_list, bind_rows) %>%
# important
arrange(all_sites, Anfang_Probenahme) %>%
# calculate loess estimates, see help(loess.as) for details of
# the set options
pred <- df_agg %>%
group_by(all_sites) %>%
nest() %>%
mutate(pred = map(data, ~ predict(
loess.as(
.x$obs[!is.na(.x$logvalue)],
.x$logvalue[!is.na(.x$logvalue)],
criterion = "aicc",
family = "gaussian",
degree = 2,
weights = sqrt(.x$weights[!is.na(.x$logvalue)]),
control = loess.control(surface = "direct")
#  user.span = span[1]
),
newdata = data.frame(x = .x$obs),
se = TRUE))) %>%
dplyr::select(pred) %>%
unnest(cols = c(pred))
# combine datasets
df_agg <- map_dfr(agg_list, bind_rows) %>%
# important
arrange(all_sites, Anfang_Probenahme) %>%
# calculate loess estimates, see help(loess.as) for details of
# the set options
pred <- df_agg %>%
group_by(all_sites) %>%
nest() %>%
mutate(pred = map(data, ~ predict(
loess.as(
.x$obs[!is.na(.x$logvalue)],
.x$logvalue[!is.na(.x$logvalue)],
criterion = "aicc",
family = "gaussian",
degree = 2,
weights = sqrt(.x$weights[!is.na(.x$logvalue)]),
control = loess.control(surface = "direct")
#  user.span = span[1]
),
newdata = data.frame(x = .x$obs),
se = TRUE))) %>%
dplyr::select(pred) %>%
unnest(cols = c(pred))
# combine datasets
df_agg <- map_dfr(agg_list, bind_rows) %>%
# important
arrange(all_sites, Anfang_Probenahme)
# calculate loess estimates, see help(loess.as) for details of
# the set options
pred <- df_agg %>%
group_by(all_sites) %>%
nest() %>%
mutate(pred = map(data, ~ predict(
loess.as(
.x$obs[!is.na(.x$logvalue)],
.x$logvalue[!is.na(.x$logvalue)],
criterion = "aicc",
family = "gaussian",
degree = 2,
weights = sqrt(.x$weights[!is.na(.x$logvalue)]),
control = loess.control(surface = "direct")
#  user.span = span[1]
),
newdata = data.frame(x = .x$obs),
se = TRUE))) %>%
dplyr::select(pred) %>%
unnest(cols = c(pred))
# store list
pred_list <- pred[, "pred"]$pred
# store number of observations per group
reps <- df_agg %>%
group_by(all_sites) %>%
summarise(n = n()) %>%
pull(n)
df_agg <- df_agg %>%
# add columns relevant for predictions
add_column(
loess_optimized = extract_prediction(lis = pred_list, extract = "fit"),
loess_optimized_se = extract_prediction(lis = pred_list, extract = "se.fit"),
loess_optimized_df = extract_prediction(pred_list, "df") %>%
map2(., reps, ~ rep(.x, .y)) %>%
unlist()
) %>%
mutate(
# add pointwise confidence bands
loess_optimized_pw_lb = loess_optimized - qt(0.975, loess_optimized_df) *
loess_optimized_se,
loess_optimized_pw_ub = loess_optimized + qt(0.975, loess_optimized_df) *
loess_optimized_se
) %>%
add_column(Standort = "Aggregiert") %>%
dplyr::select(
Standort,
all_sites,
n_non_na,
Anfang_Probenahme,
logvalue,
contains("loess_optimized"),
anteil_bev,
-contains("d_df")
) %>%
# back-transform to original scale
mutate_at(vars(contains("loess")), list(orig = ~ 10 ^ . - 1)) %>%
mutate(value = 10 ^ logvalue - 1)
df_agg <- df_agg %>%
mutate_at(vars(value, contains("orig")), ~./1000)
custom_labels <- c("ja" = "All sites", "nein" = "Sites selected for 2025")
Sys.setlocale("LC_TIME", "C")  # Forces English for dates and times
p_trans <- df_agg %>%
filter(!is.na(value)) %>%
ggplot(aes(x = Anfang_Probenahme, y = value)) +
geom_ribbon(
aes(ymin = loess_optimized_pw_lb_orig, ymax = loess_optimized_pw_ub_orig),
# shadowing cnf intervals
fill = "lightblue"
) +
geom_point(colour = "grey") +
geom_line(aes(Anfang_Probenahme,
y = loess_optimized_orig),
linewidth = 1) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_lb_orig),linewidth = 1, linetype = 0) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_ub_orig),linewidth = 1, linetype = 0) +
facet_wrap(~all_sites, ncol = 1,
labeller = labeller(all_sites = custom_labels)) +
theme_minimal() +
theme(
strip.text = element_text(size = 15),  # Increase facet title size
# Increase axis title size
axis.title.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
# Increase axis tick label size
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
) +
scale_x_date(date_breaks = "2 month",
date_labels = "%b %y") +
labs(y = expression(atop("Viral load in wastewater",atop(paste("in gene copies / liter (in thousand)")))),
x = "Date")
p_trans
View(df_agg)
names(df_agg)
# combine datasets
df_agg <- map_dfr(agg_list, bind_rows) %>%
# important
arrange(all_sites, Anfang_Probenahme)
names(df_agg)
View(df_agg)
# calculate loess estimates, see help(loess.as) for details of
# the set options
pred <- df_agg %>%
group_by(all_sites) %>%
nest() %>%
mutate(pred = map(data, ~ predict(
loess.as(
.x$obs[!is.na(.x$logvalue)],
.x$logvalue[!is.na(.x$logvalue)],
criterion = "gcv",
family = "gaussian",
degree = 2,
weights = sqrt(.x$weights[!is.na(.x$logvalue)])#,
#  control = loess.control(surface = "direct")
#  user.span = span[1]
),
newdata = data.frame(x = .x$obs),
se = TRUE))) %>%
dplyr::select(pred) %>%
unnest(cols = c(pred))
# store list
pred_list <- pred[, "pred"]$pred
# store number of observations per group
reps <- df_agg %>%
group_by(all_sites) %>%
summarise(n = n()) %>%
pull(n)
df_agg <- df_agg %>%
# add columns relevant for predictions
add_column(
loess_optimized = extract_prediction(lis = pred_list, extract = "fit"),
loess_optimized_se = extract_prediction(lis = pred_list, extract = "se.fit"),
loess_optimized_df = extract_prediction(pred_list, "df") %>%
map2(., reps, ~ rep(.x, .y)) %>%
unlist()
) %>%
mutate(
# add pointwise confidence bands
loess_optimized_pw_lb = loess_optimized - qt(0.975, loess_optimized_df) *
loess_optimized_se,
loess_optimized_pw_ub = loess_optimized + qt(0.975, loess_optimized_df) *
loess_optimized_se
) %>%
add_column(Standort = "Aggregiert") %>%
dplyr::select(
Standort,
all_sites,
n_non_na,
Anfang_Probenahme,
logvalue,
contains("loess_optimized"),
anteil_bev,
-contains("d_df")
) %>%
# back-transform to original scale
mutate_at(vars(contains("loess")), list(orig = ~ 10 ^ . - 1)) %>%
mutate(value = 10 ^ logvalue - 1)
df_agg <- df_agg %>%
mutate_at(vars(value, contains("orig")), ~./1000)
custom_labels <- c("ja" = "All sites", "nein" = "Sites selected for 2025")
Sys.setlocale("LC_TIME", "C")  # Forces English for dates and times
p_trans <- df_agg %>%
filter(!is.na(value)) %>%
ggplot(aes(x = Anfang_Probenahme, y = value)) +
geom_ribbon(
aes(ymin = loess_optimized_pw_lb_orig, ymax = loess_optimized_pw_ub_orig),
# shadowing cnf intervals
fill = "lightblue"
) +
geom_point(colour = "grey") +
geom_line(aes(Anfang_Probenahme,
y = loess_optimized_orig),
linewidth = 1) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_lb_orig),linewidth = 1, linetype = 0) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_ub_orig),linewidth = 1, linetype = 0) +
facet_wrap(~all_sites, ncol = 1,
labeller = labeller(all_sites = custom_labels)) +
theme_minimal() +
theme(
strip.text = element_text(size = 15),  # Increase facet title size
# Increase axis title size
axis.title.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
# Increase axis tick label size
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
) +
scale_x_date(date_breaks = "2 month",
date_labels = "%b %y") +
labs(y = expression(atop("Viral load in wastewater",atop(paste("in gene copies / liter (in thousand)")))),
x = "Date")
p_trans
# calculate loess estimates, see help(loess.as) for details of
# the set options
pred <- df_agg %>%
group_by(all_sites) %>%
nest() %>%
mutate(pred = map(data, ~ predict(
loess.as(
.x$obs[!is.na(.x$logvalue)],
.x$logvalue[!is.na(.x$logvalue)],
criterion = "gcv",
family = "symmetric",
degree = 2,
weights = sqrt(.x$weights[!is.na(.x$logvalue)]),
control = loess.control(surface = "direct")
#  user.span = span[1]
),
newdata = data.frame(x = .x$obs),
se = TRUE))) %>%
dplyr::select(pred) %>%
unnest(cols = c(pred))
df_agg <- df_agg %>%
# add columns relevant for predictions
add_column(
loess_optimized = extract_prediction(lis = pred_list, extract = "fit"),
loess_optimized_se = extract_prediction(lis = pred_list, extract = "se.fit"),
loess_optimized_df = extract_prediction(pred_list, "df") %>%
map2(., reps, ~ rep(.x, .y)) %>%
unlist()
) %>%
mutate(
# add pointwise confidence bands
loess_optimized_pw_lb = loess_optimized - qt(0.975, loess_optimized_df) *
loess_optimized_se,
loess_optimized_pw_ub = loess_optimized + qt(0.975, loess_optimized_df) *
loess_optimized_se
) %>%
add_column(Standort = "Aggregiert") %>%
dplyr::select(
Standort,
all_sites,
n_non_na,
Anfang_Probenahme,
logvalue,
contains("loess_optimized"),
anteil_bev,
-contains("d_df")
) %>%
# back-transform to original scale
mutate_at(vars(contains("loess")), list(orig = ~ 10 ^ . - 1)) %>%
mutate(value = 10 ^ logvalue - 1)
# combine datasets
df_agg <- map_dfr(agg_list, bind_rows) %>%
# important
arrange(all_sites, Anfang_Probenahme)
# calculate loess estimates, see help(loess.as) for details of
# the set options
pred <- df_agg %>%
group_by(all_sites) %>%
nest() %>%
mutate(pred = map(data, ~ predict(
loess.as(
.x$obs[!is.na(.x$logvalue)],
.x$logvalue[!is.na(.x$logvalue)],
criterion = "gcv",
family = "symmetric",
degree = 2,
weights = sqrt(.x$weights[!is.na(.x$logvalue)]),
control = loess.control(surface = "direct")
#  user.span = span[1]
),
newdata = data.frame(x = .x$obs),
se = TRUE))) %>%
dplyr::select(pred) %>%
unnest(cols = c(pred))
# store list
pred_list <- pred[, "pred"]$pred
# store number of observations per group
reps <- df_agg %>%
group_by(all_sites) %>%
summarise(n = n()) %>%
pull(n)
df_agg <- df_agg %>%
# add columns relevant for predictions
add_column(
loess_optimized = extract_prediction(lis = pred_list, extract = "fit"),
loess_optimized_se = extract_prediction(lis = pred_list, extract = "se.fit"),
loess_optimized_df = extract_prediction(pred_list, "df") %>%
map2(., reps, ~ rep(.x, .y)) %>%
unlist()
) %>%
mutate(
# add pointwise confidence bands
loess_optimized_pw_lb = loess_optimized - qt(0.975, loess_optimized_df) *
loess_optimized_se,
loess_optimized_pw_ub = loess_optimized + qt(0.975, loess_optimized_df) *
loess_optimized_se
) %>%
add_column(Standort = "Aggregiert") %>%
dplyr::select(
Standort,
all_sites,
n_non_na,
Anfang_Probenahme,
logvalue,
contains("loess_optimized"),
anteil_bev,
-contains("d_df")
) %>%
# back-transform to original scale
mutate_at(vars(contains("loess")), list(orig = ~ 10 ^ . - 1)) %>%
mutate(value = 10 ^ logvalue - 1)
df_agg <- df_agg %>%
mutate_at(vars(value, contains("orig")), ~./1000)
custom_labels <- c("ja" = "All sites", "nein" = "Sites selected for 2025")
Sys.setlocale("LC_TIME", "C")  # Forces English for dates and times
p_trans <- df_agg %>%
filter(!is.na(value)) %>%
ggplot(aes(x = Anfang_Probenahme, y = value)) +
geom_ribbon(
aes(ymin = loess_optimized_pw_lb_orig, ymax = loess_optimized_pw_ub_orig),
# shadowing cnf intervals
fill = "lightblue"
) +
geom_point(colour = "grey") +
geom_line(aes(Anfang_Probenahme,
y = loess_optimized_orig),
linewidth = 1) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_lb_orig),linewidth = 1, linetype = 0) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_ub_orig),linewidth = 1, linetype = 0) +
facet_wrap(~all_sites, ncol = 1,
labeller = labeller(all_sites = custom_labels)) +
theme_minimal() +
theme(
strip.text = element_text(size = 15),  # Increase facet title size
# Increase axis title size
axis.title.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
# Increase axis tick label size
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
) +
scale_x_date(date_breaks = "2 month",
date_labels = "%b %y") +
labs(y = expression(atop("Viral load in wastewater",atop(paste("in gene copies / liter (in thousand)")))),
x = "Date")
p_trans
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
readRDS(here(read_data_here, "all_data.rds")) %>%
mutate(Anfang_Probenahme = as.Date(Anfang_Probenahme),
logvalue = log10(value + 1),
loq = as.logical(below_lod))
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
# combine datasets
df_agg <- map_dfr(agg_list, bind_rows) %>%
# important
arrange(all_sites, Anfang_Probenahme)
names(df_agg)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
View(df_agg)
p_trans <- df_agg %>%
filter(!is.na(value)) %>%
ggplot(aes(x = Anfang_Probenahme, y = value)) +
geom_ribbon(
aes(ymin = loess_optimized_pw_lb_orig, ymax = loess_optimized_pw_ub_orig),
# shadowing cnf intervals
fill = "lightblue"
) +
#  geom_point(colour = "grey") +
geom_line(aes(Anfang_Probenahme,
y = loess_optimized_orig),
linewidth = 1) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_lb_orig),linewidth = 1, linetype = 0) +
geom_line(aes(Anfang_Probenahme, y = loess_optimized_pw_ub_orig),linewidth = 1, linetype = 0) +
facet_wrap(~all_sites, ncol = 1,
labeller = labeller(all_sites = custom_labels)) +
theme_minimal() +
theme(
strip.text = element_text(size = 15),  # Increase facet title size
# Increase axis title size
axis.title.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
# Increase axis tick label size
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
) +
scale_x_date(date_breaks = "2 month",
date_labels = "%b %y") +
labs(y = expression(atop("Viral load in wastewater",atop(paste("in gene copies / liter (in thousand)")))),
x = "Date")
p_trans
source("S:/Projekte/FG32_Abwassersurveillance/Daten/Amelag/Standortpaper/Scripts/plots_curves.R", echo = TRUE)
